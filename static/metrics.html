<!doctype html>
<meta charset="utf-8" />
<title>Metrics</title>
<style>
  body{font:14px system-ui, -apple-system, Segoe UI, Roboto; margin:20px; color:#111}
  .row{display:flex; gap:16px; margin-bottom:16px}
  .card{padding:12px 16px; border:1px solid #ddd; border-radius:10px}
  table{border-collapse:collapse; width:100%}
  th,td{border-bottom:1px solid #eee; padding:6px 8px; text-align:left; font-size:12px}
  th{font-weight:700}
</style>
<div class="row">
  <div class="card" id="hit"></div>
  <div class="card" id="ttfb"></div>
  <div class="card" id="bytes"></div>
  <div class="card" id="mix"></div>
  <div style="margin-left:auto">
    <input id="token" placeholder="token (optional)" />
    <button id="load">Load</button>
  </div>
  </div>
<table id="t"><thead><tr>
  <th>ts</th><th>cache</th><th>ttfb</th><th>bytes</th><th>model</th><th>hash</th>
</tr></thead><tbody></tbody></table>
<script>
async function load(){
  const token = document.getElementById('token').value.trim();
  const url = '/admin/metrics.json' + (token ? ('?token='+encodeURIComponent(token)) : '');
  const r = await fetch(url, {cache:'no-store'});
  const j = await r.json();
  const rows = j.rows || [];
  const tbody = document.querySelector('#t tbody'); tbody.innerHTML = '';
  let hits = 0, total = rows.length, sumT=0, sumB=0, previews=0, full=0;
  for (const row of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.ts_ms||row.ts||''}</td><td>${row.cache||''}</td><td>${row.ttfb_ms||row.ttfb||''}</td><td>${row.bytes||''}</td><td>${row.model||''}</td><td>${row.hash||''}</td>`;
    tbody.appendChild(tr);
    if (row.cache === 'disk' || row.cache === 'mem') hits++;
    sumT += +(row.ttfb_ms||row.ttfb||0);
    sumB += +(row.bytes||0);
    if (row.model && row.model.indexOf('flash')>=0) previews++;
    else full++;
  }
  document.getElementById('hit').textContent = `Cache hit: ${total?Math.round(hits*100/total):0}%`;
  document.getElementById('ttfb').textContent = `Avg TTFB: ${total?Math.round(sumT/total):0} ms`;
  document.getElementById('bytes').textContent = `Avg bytes: ${total?Math.round(sumB/total):0}`;
  document.getElementById('mix').textContent = `Mix: preview=${previews} full=${full}`;
}
document.getElementById('load').onclick = load;
load();
</script>

