<!doctype html>
<meta charset="utf-8"/>
<title>AI Listen · Analytics</title>
<style>
  :root{ --bg:#0e1318; --fg:#eaf2ff; --card:#121a22; --border:#1e2833; --accent:#4da3ff; --muted:#9fb4cc; --radius:16px; }
  *{ box-sizing:border-box }
  body{ margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--fg); }
  header{ padding:20px 16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); position:sticky; top:0; background:linear-gradient(180deg,var(--bg),rgba(14,19,24,.9)); backdrop-filter:saturate(120%) blur(6px) }
  h1{ margin:0; font-size:16px }
  main{ max-width:1000px; margin:16px auto; padding:0 16px; display:grid; gap:16px }
  .row{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px }
  .k{ font-size:12px; color:var(--muted) }
  .v{ font-size:22px; font-weight:650; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ text-align:left; padding:10px; border-bottom:1px solid var(--border) }
  th{ font-size:12px; color:var(--muted) }
  a.btn{ color:var(--fg); text-decoration:none; border:1px solid var(--border); padding:8px 10px; border-radius:10px; background:#0f1720 }
  input,select{ background:#0f1720; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 10px }
  .actions{ display:flex; gap:8px; align-items:center }
</style>
<header>
  <h1>AI Listen · Analytics</h1>
  <div class="actions">
    <label class="k">Tenant</label>
    <input id="tenant" placeholder="(all)"/>
    <label class="k">Since (hrs)</label>
    <select id="hrs">
      <option value="0">all</option>
      <option>1</option><option>6</option><option selected>24</option><option>72</option><option>168</option>
    </select>
    <a id="dl" class="btn" href="/admin/analytics.csv">Download CSV</a>
    <a id="refresh" class="btn" href="#">Refresh</a>
  </div>
</header>
<main>
  <div class="row" style="grid-template-columns: repeat(4, 1fr);">
    <div class="card"><div class="k">Impressions</div><div class="v" id="impr">–</div></div>
    <div class="card"><div class="k">Clicks</div><div class="v" id="clicks">–</div></div>
    <div class="card"><div class="k">CTR</div><div class="v" id="ctr">–</div></div>
    <div class="card"><div class="k">Listening (min)</div><div class="v" id="mins">–</div></div>
  </div>
  <div class="card">
    <div class="k">Top URLs</div>
    <table id="tbl">
      <thead><tr><th>URL</th><th>Clicks</th><th>Seconds</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card">
    <div class="k">Daily (last 14)</div>
    <table id="daily">
      <thead><tr><th>Date (UTC)</th><th>Clicks</th><th>Minutes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</main>
<script>
  async function load(){
    const t = document.getElementById('tenant').value.trim();
    const hrs = parseInt(document.getElementById('hrs').value||"0",10);
    const sinceTs = hrs ? Math.floor(Date.now()/1000) - hrs*3600 : 0;

    // summary
    let url = '/admin/analytics.json';
    const qs = [];
    if (t) qs.push('tenant='+encodeURIComponent(t));
    if (sinceTs) qs.push('since_ts='+sinceTs);
    if (qs.length) url += '?'+qs.join('&');

    const j = await (await fetch(url)).json();
    const impr = j.total_impressions || 0;
    const clicks = j.total_clicks || 0;
    const secs = j.total_seconds || 0;

    document.getElementById('impr').textContent   = impr;
    document.getElementById('clicks').textContent = clicks;
    document.getElementById('mins').textContent   = (secs/60).toFixed(1);
    document.getElementById('ctr').textContent    = impr ? ((clicks/impr)*100).toFixed(1)+'%' : '0%';

    // top urls (add CTR column in-place)
    const rows = Object.entries(j.by_url||{}).map(([u,v]) => {
      const ctr = v.impressions ? (v.clicks/v.impressions*100) : 0;
      return [u, v.clicks||0, v.seconds||0, v.impressions||0, ctr];
    }).sort((a,b)=> b[1]-a[1]).slice(0,50);

    const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';
    for (const [u,c,s,imp,ctr] of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="max-width:620px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                        <a href="${u}" target="_blank">${u}</a>
                      </td>
                      <td>${c}</td><td>${s.toFixed(1)}</td>`;
      tb.appendChild(tr);
    }

    // daily (last 14 days)
    let dailyUrl = '/admin/analytics_timeseries.json?days=14';
    if (t) dailyUrl += '&tenant='+encodeURIComponent(t);
    const d = await (await fetch(dailyUrl)).json();
    const dTB = document.querySelector('#daily tbody'); dTB.innerHTML = '';
    for (let i=0;i<d.days.length;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.days[i]}</td><td>${d.clicks[i]}</td><td>${(d.seconds[i]/60).toFixed(1)}</td>`;
      dTB.appendChild(tr);
    }
  }
  document.getElementById('refresh').onclick = (e)=>{ e.preventDefault(); load(); };
  document.getElementById('hrs').onchange = load;
  document.getElementById('tenant').onchange = load;
  load();
</script>
